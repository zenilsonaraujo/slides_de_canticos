<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slides de Cânticos - Apresentação</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            background: #000000; /* Preto como padrão */
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 0; /* Reduzido de 20px para 0 */
        }

        #presentation-container {
            width: 100%;
            max-width: 100%; /* Alterado de 1200px para 100% */
            height: 100vh; /* Alterado de 90vh para 100vh */
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 0; /* Removido para usar toda a área */
            overflow: hidden;
            box-shadow: none; /* Removido para não ocupar espaço visual */
        }

        #header {
            padding: 5px 10px; /* Reduzido de 15px 20px */
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 40px; /* Definido tamanho mínimo */
        }

        #title {
            font-size: 1.2rem; /* Reduzido de 1.5rem */
            font-weight: bold;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        #progress {
            font-size: 0.9rem; /* Reduzido de 1rem */
            color: #ccc;
        }

        #slide-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px; /* Reduzido drasticamente de 30px */
            position: relative;
            overflow: hidden;
        }

        #slide {
            font-size: 4rem; /* Aumentado de 3rem para 4rem */
            text-align: center;
            width: 98%; /* Aumentado de 90% */
            max-width: 98%; /* Aumentado de 90% */
            max-height: 98%; /* Aumentado de 90% */
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
            line-height: 1.3; /* Reduzido de 1.5 para melhor aproveitamento vertical */
            white-space: pre-line;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            text-transform: uppercase;
            font-weight: 900;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        /* Estilos diferenciados para estrofes e refrões - TODAS BRANCAS */
        .estrofe {
            color: #ffffff;
            font-weight: 700;
            letter-spacing: 1px;
            opacity: 0;
            animation: fadeIn 0.8s ease-in-out forwards;
            line-height: 1.2; /* Reduzido de 1.4 */
            margin-bottom: 0.2em; /* Adicionado espaçamento controlado */
        }

        .refrao {
            color: #ffffff;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            opacity: 0;
            animation: fadeIn 0.8s ease-in-out 0.2s forwards;
            line-height: 1.2; /* Reduzido de 1.4 */
            margin-bottom: 0.2em; /* Adicionado espaçamento controlado */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px); /* Reduzido de 20px */
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .font-controls {
            display: flex;
            gap: 5px; /* Reduzido de 10px */
            align-items: center;
        }

        .font-btn {
            padding: 3px 8px; /* Reduzido de 5px 12px */
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid #ffd700;
            border-radius: 3px; /* Reduzido de 5px */
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.8rem; /* Adicionado para manter legibilidade */
        }

        .font-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            top: 10px; /* Ajustado de 20px */
            right: 10px; /* Ajustado de 20px */
            padding: 10px 15px; /* Reduzido de 15px 25px */
            background: #4CAF50;
            color: white;
            border-radius: 5px; /* Reduzido de 8px */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out, slideOut 0.3s ease-in 2.7s;
            opacity: 0;
            font-size: 0.9rem; /* Adicionado para manter legibilidade */
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .music-transition {
            animation: musicChange 1s ease-in-out;
        }

        @keyframes musicChange {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .visible {
            opacity: 1 !important;
            transform: scale(1) !important;
        }

        /* Tela de configuração */
        #config-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000; /* Preto como padrão */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            padding: 10px; /* Reduzido de 20px */
        }

        .config-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px; /* Reduzido de 30px */
            border-radius: 10px; /* Reduzido de 15px */
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .config-panel h2 {
            color: #ffd700;
            margin-bottom: 15px; /* Reduzido de 20px */
            font-size: 1.8rem; /* Reduzido de 2rem */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .config-option {
            margin: 15px 0; /* Reduzido de 20px 0 */
            text-align: left;
        }

        .config-option label {
            display: block;
            margin-bottom: 5px; /* Reduzido de 8px */
            font-weight: bold;
        }

        .file-input {
            width: 100%;
            padding: 8px; /* Reduzido de 10px */
            border: 2px dashed #ffd700;
            border-radius: 5px; /* Reduzido de 8px */
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
        }

        .file-input:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn {
            padding: 10px 20px; /* Reduzido de 12px 30px */
            border: none;
            border-radius: 40px; /* Reduzido de 50px */
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px; /* Reduzido de 10px */
            font-size: 0.9rem; /* Reduzido de 1rem */
            text-transform: uppercase;
            border: 1px solid #ffd700;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-primary {
            background: #ffd700;
            color: #1a1a1a;
        }

        .btn-primary:hover {
            background: #ffed4e;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px; /* Reduzido de 15px */
            border-radius: 5px; /* Reduzido de 8px */
            margin-top: 15px; /* Reduzido de 20px */
            text-align: left;
            max-height: 350px; /* Reduzido de 400px */
            overflow-y: auto;
        }

        .instructions h3 {
            color: #ffd700;
            margin-bottom: 8px; /* Reduzido de 10px */
            font-size: 0.9rem; /* Reduzido de 1rem */
        }

        .instructions ol {
            padding-left: 15px; /* Reduzido de 20px */
            font-size: 0.85rem; /* Reduzido de 0.9rem */
        }

        .instructions li {
            margin-bottom: 4px; /* Reduzido de 5px */
            line-height: 1.2; /* Reduzido de 1.3 */
        }

        .instructions pre {
            font-size: 0.7rem; /* Reduzido de 0.75rem */
            max-height: 180px; /* Reduzido de 200px */
            overflow-y: auto;
        }

        /* Indicador de loop */
        .loop-indicator {
            position: absolute;
            bottom: 10px; /* Reduzido de 20px */
            left: 10px; /* Reduzido de 20px */
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 6px; /* Reduzido de 5px 10px */
            border-radius: 3px; /* Reduzido de 5px */
            font-size: 0.7rem; /* Reduzido de 0.8rem */
            color: #ffd700;
            display: none;
        }

        /* Indicador de slide vazio */
        .empty-slide-indicator {
            position: absolute;
            bottom: 10px; /* Reduzido de 20px */
            right: 10px; /* Reduzido de 20px */
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 6px; /* Reduzido de 5px 10px */
            border-radius: 3px; /* Reduzido de 5px */
            font-size: 0.7rem; /* Reduzido de 0.8rem */
            color: #ffd700;
            display: none;
        }

        /* Cores litúrgicas */
        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Reduzido de 10px */
            justify-content: center;
            margin: 15px 0; /* Reduzido de 20px 0 */
        }

        .color-option {
            width: 50px; /* Reduzido de 60px */
            height: 50px; /* Reduzido de 60px */
            border-radius: 8px; /* Reduzido de 10px */
            cursor: pointer;
            border: 2px solid transparent; /* Reduzido de 3px */
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8); /* Reduzido de 15px */
        }

        .color-label {
            font-size: 0.7rem; /* Reduzido de 0.8rem */
            margin-top: 3px; /* Reduzido de 5px */
            text-align: center;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            #slide {
                font-size: 3rem; /* Aumentado de 2.2rem */
            }
            
            #title {
                font-size: 1rem; /* Reduzido de 1.2rem */
            }
            
            .config-panel h2 {
                font-size: 1.3rem; /* Reduzido de 1.5rem */
            }

            .color-options {
                gap: 4px; /* Reduzido de 5px */
            }

            .color-option {
                width: 45px; /* Reduzido de 50px */
                height: 45px; /* Reduzido de 50px */
            }
        }
    </style>
</head>
<body>

<div id="config-screen">
    <div class="config-panel">
        <h2>CONFIGURAÇÃO DE CÂNTICOS</h2>
        
        <div class="config-option">
            <label for="file-input">CARREGAR ARQUIVO DE CÂNTICOS (TXT):</label>
            <input type="file" id="file-input" class="file-input" accept=".txt" aria-label="Carregar arquivo de cânticos">
        </div>

        <div class="config-option">
            <label>SELECIONE A COR DE FUNDO:</label>
            <div class="color-options">
                <div class="color-option-group">
                    <div class="color-option selected" style="background: #000000;" data-color="preto" onclick="selectColor('preto')"></div>
                    <div class="color-label">Preto</div>
                </div>
                <div class="color-option-group">
                    <div class="color-option" style="background: #006400;" data-color="verde" onclick="selectColor('verde')"></div>
                    <div class="color-label">Verde</div>
                </div>
                <div class="color-option-group">
                    <div class="color-option" style="background: #450000;" data-color="vermelho" onclick="selectColor('vermelho')"></div>
                    <div class="color-label">Vermelho</div>
                </div>
                <div class="color-option-group">
                    <div class="color-option" style="background: #2D0045;" data-color="roxo" onclick="selectColor('roxo')"></div>
                    <div class="color-label">Roxo</div>
                </div>
                <div class="color-option-group">
                    <div class="color-option" style="background: #000045;" data-color="azul" onclick="selectColor('azul')"></div>
                    <div class="color-label">Azul</div>
                </div>
                <div class="color-option-group">
                    <div class="color-option" style="background: #FFFFFF; border: 1px solid #ccc;" data-color="branco" onclick="selectColor('branco')"></div>
                    <div class="color-label">Branco</div>
                </div>
            </div>
        </div>

        <div style="margin: 15px 0;">
            <button class="btn" onclick="startWithDefault()" aria-label="Cânticos de exemplo">CÂNTICOS DE EXEMPLO</button>
            <button class="btn" onclick="showInstructions()" aria-label="Mostrar instruções">INSTRUÇÕES</button>
            <button class="btn" onclick="exportMusicas()" aria-label="Exportar configuração">EXPORTAR</button>
            <button class="btn btn-primary" onclick="startPresentation()" aria-label="Iniciar apresentação">INICIAR APRESENTAÇÃO</button>
        </div>

        <div id="instructions" class="instructions" style="display: none;">
            <h3>FORMATO DO ARQUIVO (MELHORADO):</h3>
            <ol>
                <li>Cada canto começa com <strong>===NOME===</strong></li>
                <li>Separe estrofes com linha em branco</li>
                <li>Use <strong>#E</strong> para marcar estrofes e <strong>#R</strong> para refrões (não aparecem nos slides)</li>
                <li>Opcional: termine com <strong>===FIM===</strong></li>
            </ol>
            
            <h3>EXEMPLO DISCRETO:</h3>
            <pre style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 3px;">===A NÓS DESCEI DIVINA LUZ===
#E
A NÓS DESCEI DIVINA LUZ
E O NOSSO FOGO ACENDEI

#R
VEM ESPÍRITO SANTO VEM
VEM ILUMINAR

#E
COMO NO DIA DE PENTECOSTES
DESCEI SOBRE NÓS SENHOR

#R
VEM ESPÍRITO SANTO VEM
VEM ILUMINAR</pre>
            
            <button class="btn" onclick="hideInstructions()" aria-label="Fechar instruções">FECHAR</button>
        </div>
    </div>
</div>

<div id="presentation-container" style="display: none;">
    <div id="header">
        <div id="title">Slides de Cânticos</div>
        <div class="font-controls">
            <button class="font-btn" onclick="decreaseFontSize()" aria-label="Diminuir fonte">A-</button>
            <button class="font-btn" onclick="increaseFontSize()" aria-label="Aumentar fonte">A+</button>
            <button class="font-btn" onclick="resetAutoAdjust()" aria-label="Redefinir ajuste automático">AUTO</button>
        </div>
        <div id="progress" aria-live="polite">1/1</div>
    </div>
    
    <div id="slide-container">
        <div id="slide" role="main" aria-live="polite"></div>
        <div class="loop-indicator" id="loop-indicator">LOOP ATIVO</div>
        <div class="empty-slide-indicator" id="empty-slide-indicator">SLIDE VAZIO</div>
    </div>
</div>

<script>
    // =============================
    // ESTADO DA APLICAÇÃO
    // =============================
    const appState = {
        musicas: [],
        musicaAtual: 0,
        slideAtual: 0,
        fontSize: 4, // Aumentado de 3 para 4
        animationFrame: null,
        loopAtivo: false,
        inicioDoCantico: true,
        corFundo: 'preto',
        autoAdjustEnabled: true,
        baseFontSize: 4 // Aumentado de 3 para 4
    };

    // =============================
    // LISTA DE CÂNTICOS QUE DEVEM REPETIR (LOOP)
    // =============================
    const canticosComRepeticao = [
        "CANTO INICIAL",
        "APRESENTAÇÃO DAS OFERTAS", 
        "CANTO DE COMUNHÃO",
        "CANTO DE DESPEDIDA"
    ];

    // =============================
    // CÂNTICOS PADRÃO (FALLBACK) - FORMATO DISCRETO
    // =============================
    const defaultMusicas = [
        {
            titulo: "CANTO INICIAL",
            slides: [
                "",
                "#E\nCANTO INICIAL DA MISSA\nDE HOJE VAMOS CANTAR\nALELUIA, ALELUIA\nLOUVEMOS AO SENHOR",
                "#R\nCANTO INICIAL, CANTO INICIAL\nVAMOS TODOS CANTAR\nCANTO INICIAL, CANTO INICIAL\nLOUVEMOS AO SENHOR",
                "#E\nCOM ALEGRIA NO CORAÇÃO\nNOS REUNIMOS AQUI\nPARA LOUVAR A DEUS\nNOSSO PAI E SENHOR",
                "#R\nCANTO INICIAL, CANTO INICIAL\nVAMOS TODOS CANTAR\nCANTO INICIAL, CANTO INICIAL\nLOUVEMOS AO SENHOR",
                ""
            ]
        },
        {
            titulo: "ATO PENITENCIAL",
            slides: [
                "",
                "#E\nTEM PIEDADE DE NÓS, SENHOR\nPECAMOS CONTRA VÓS",
                "#E\nMOSTRAI-NOS, SENHOR, VOSSA MISERICÓRDIA\nE A VOSSA SALVAÇÃO NOS DAI",
                ""
            ]
        },
        {
            titulo: "APRESENTAÇÃO DAS OFERTAS",
            slides: [
                "",
                "#E\nTRAZEMOS NOSSAS OFERTAS\nAO ALTAR DO SENHOR",
                "#R\nACEITAI, SENHOR, NOSSAS OFERTAS\nE NOS ABENÇOAI",
                "#E\nPÃO E VINHO CONSAGRADOS\nPARA NOSSA SALVAÇÃO",
                "#R\nACEITAI, SENHOR, NOSSAS OFERTAS\nE NOS ABENÇOAI",
                ""
            ]
        },
        {
            titulo: "SANTO",
            slides: [
                "",
                "#E\nSANTO, SANTO, SANTO\nSENHOR DEUS DO UNIVERSO\nO CÉU E A TERRA PROCLAMAM\nVOSSA GLÓRIA",
                "#E\nHOSANA NAS ALTURAS\nBENDITO O QUE VEM\nEM NOME DO SENHOR\nHOSANA NAS ALTURAS",
                ""
            ]
        },
        {
            titulo: "CORDEIRO DE DEUS",
            slides: [
                "",
                "#E\nCORDEIRO DE DEUS\nQUE TIRAIS O PECADO DO MUNDO\nTEM PIEDADE DE NÓS",
                "#E\nCORDEIRO DE DEUS\nQUE TIRAIS O PECADO DO MUNDO\nTEM PIEDADE DE NÓS",
                "#E\nCORDEIRO DE DEUS\nQUE TIRAIS O PECADO DO MUNDO\nDAI-NOS A PAZ",
                ""
            ]
        },
        {
            titulo: "CANTO DE COMUNHÃO",
            slides: [
                "",
                "#E\nVINDE A MIM TODOS VÓS\nQUE ESTAIS AFLITOS",
                "#R\nO PÃO DA VIDA É CRISTO\nQUE SE ENTREGOU POR NÓS",
                "#E\nQUEM COME MINHA CARNE\nE BEBE MEU SANGUREM MIM PERMANECE\nE EU NELE",
                "#R\nO PÃO DA VIDA É CRISTO\nQUE SE ENTREGOU POR NÓS",
                ""
            ]
        },
        {
            titulo: "CANTO DE DESPEDIDA",
            slides: [
                "",
                "#E\nA MISSA TERMINOU\nIDE EM PAZ",
                "#R\nIDE EM PAZ, IDE EM PAZ\nPARA ANUNCIAR O EVANGELHO",
                "#E\nLEVAI A BOA NOVA\nA TODOS OS POVOS",
                "#R\nIDE EM PAZ, IDE EM PAZ\nPARA ANUNCIAR O EVANGELHO",
                ""
            ]
        }
    ];

    const slideDiv = document.getElementById("slide");
    const titleDiv = document.getElementById("title");
    const progressDiv = document.getElementById("progress");
    const configScreen = document.getElementById("config-screen");
    const presentationContainer = document.getElementById("presentation-container");
    const fileInput = document.getElementById("file-input");
    const loopIndicator = document.getElementById("loop-indicator");
    const emptySlideIndicator = document.getElementById("empty-slide-indicator");

    // =============================
    // FUNÇÕES DE AJUSTE AUTOMÁTICO DE FONTE
    // =============================

    function ajustarFonteParaCaber() {
        if (!appState.autoAdjustEnabled) return;
        
        const container = document.getElementById('slide-container');
        const slide = document.getElementById('slide');
        
        // Reset para o tamanho base
        slide.style.fontSize = appState.baseFontSize + 'rem';
        
        // Dimensões do container
        const containerWidth = container.clientWidth - 10; // padding reduzido
        const containerHeight = container.clientHeight - 10; // padding reduzido
        
        // Dimensões atuais do slide
        let slideWidth = slide.scrollWidth;
        let slideHeight = slide.scrollHeight;
        
        let fontSize = appState.baseFontSize;
        
        // Ajusta até caber no container
        while ((slideWidth > containerWidth || slideHeight > containerHeight) && fontSize > 1.0) {
            fontSize -= 0.1;
            slide.style.fontSize = fontSize + 'rem';
            
            // Atualiza dimensões após mudança de fonte
            slideWidth = slide.scrollWidth;
            slideHeight = slide.scrollHeight;
        }
        
        // Se ainda não couber, ajusta o line-height
        if (slideHeight > containerHeight && fontSize > 0.8) {
            const estrofes = slide.querySelectorAll('.estrofe');
            const refroes = slide.querySelectorAll('.refrao');
            let currentLineHeight = 1.2; // Reduzido de 1.4
            
            while (slideHeight > containerHeight && currentLineHeight > 1.0) { // Reduzido de 1.1
                currentLineHeight -= 0.05;
                estrofes.forEach(linha => {
                    linha.style.lineHeight = currentLineHeight;
                });
                refroes.forEach(linha => {
                    linha.style.lineHeight = currentLineHeight;
                });
                slideHeight = slide.scrollHeight;
            }
        }
        
        return fontSize;
    }

    function resetAutoAdjust() {
        appState.autoAdjustEnabled = !appState.autoAdjustEnabled;
        
        if (appState.autoAdjustEnabled) {
            showNotification('Ajuste automático ATIVADO');
            // Reaplica o ajuste automático
            setTimeout(() => {
                ajustarFonteParaCaber();
            }, 100);
        } else {
            showNotification('Ajuste automático DESATIVADO');
            // Restaura o tamanho base
            slideDiv.style.fontSize = appState.baseFontSize + 'rem';
            
            // Restaura line-height padrão
            const estrofes = slideDiv.querySelectorAll('.estrofe');
            const refroes = slideDiv.querySelectorAll('.refrao');
            estrofes.forEach(linha => {
                linha.style.lineHeight = '1.2'; // Reduzido de 1.4
            });
            refroes.forEach(linha => {
                linha.style.lineHeight = '1.2'; // Reduzido de 1.4
            });
        }
        
        // Atualiza o botão
        const autoBtn = document.querySelector('.font-btn:last-child');
        autoBtn.textContent = appState.autoAdjustEnabled ? 'AUTO ON' : 'AUTO OFF';
        autoBtn.style.background = appState.autoAdjustEnabled ? 
            'rgba(255, 215, 0, 0.3)' : 'rgba(255, 255, 255, 0.2)';
    }

    // =============================
    // FUNÇÕES AUXILIARES
    // =============================

    // Função para verificar se o cântico atual DEVE repetir
    function deveRepetirCantico(titulo) {
        return canticosComRepeticao.some(nome => 
            titulo.toUpperCase().includes(nome)
        );
    }

    // Função para contar slides com conteúdo em um cântico
    function contarSlidesComConteudo(musica) {
        let count = 0;
        for (let i = 0; i < musica.slides.length; i++) {
            if (musica.slides[i].trim() !== '') {
                count++;
            }
        }
        return count;
    }

    // Função para encontrar o próximo slide com conteúdo
    function encontrarProximoSlideComConteudo(musica, slideAtual) {
        let proximoSlide = slideAtual + 1;
        
        // Percorre os slides até encontrar um com conteúdo
        while (proximoSlide < musica.slides.length) {
            if (musica.slides[proximoSlide].trim() !== '') {
                return proximoSlide;
            }
            proximoSlide++;
        }
        
        // Se não encontrou, retorna -1
        return -1;
    }

    // Função para encontrar o primeiro slide com conteúdo
    function encontrarPrimeiroSlideComConteudo(musica) {
        for (let i = 0; i < musica.slides.length; i++) {
            if (musica.slides[i].trim() !== '') {
                return i;
            }
        }
        return -1; // Nenhum slide com conteúdo encontrado
    }

    // Função para aplicar estilos diferenciados (SEM PALAVRAS ESTROFE/REFRAO)
    function aplicarEstiloDiferenciado(texto) {
        // Divide o texto em linhas
        const linhas = texto.split('\n');
        let resultado = '';
        let contextoAtual = 'estrofe'; // padrão
        
        for (let linha of linhas) {
            const linhaTrim = linha.trim();
            
            // Verifica se é um marcador discreto
            if (linhaTrim === '#E') {
                contextoAtual = 'estrofe';
                continue; // Não adiciona ao resultado
            } else if (linhaTrim === '#R') {
                contextoAtual = 'refrao';
                continue; // Não adiciona ao resultado
            }
            
            // Adiciona a linha com a classe apropriada
            if (linhaTrim !== '') {
                resultado += `<div class="${contextoAtual}">${linha}</div>`;
            } else {
                resultado += '<br>';
            }
        }
        
        return resultado;
    }

    // Função para selecionar cor de fundo
    function selectColor(cor) {
        appState.corFundo = cor;
        
        // Atualiza a seleção visual
        document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`[data-color="${cor}"]`).classList.add('selected');
        
        // Aplica a cor ao fundo da configuração para preview
        aplicarCorFundo(configScreen, cor);
    }

    // Função para aplicar cor de fundo
    function aplicarCorFundo(elemento, cor) {
        const cores = {
            'preto': '#000000',
            'verde': '#006400',
            'vermelho': '#450000',
            'roxo': '#2D0045',
            'azul': '#000045',
            'branco': '#FFFFFF'
        };
        
        elemento.style.background = cores[cor];
        
        // Se for branco, mantém o texto branco
        if (cor === 'branco') {
            elemento.style.color = '#ffffff';
            document.querySelectorAll('.config-panel, .instructions').forEach(el => {
                el.style.background = 'rgba(0, 0, 0, 0.1)';
                el.style.color = '#ffffff';
            });
        } else {
            elemento.style.color = '#ffffff';
            document.querySelectorAll('.config-panel, .instructions').forEach(el => {
                el.style.background = 'rgba(255, 255, 255, 0.1)';
                el.style.color = '#ffffff';
            });
        }
    }

    // =============================
    // FUNÇÕES DE CONFIGURAÇÃO
    // =============================

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.background = type === 'success' ? '#4CAF50' : '#f44336';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    function showInstructions() {
        document.getElementById('instructions').style.display = 'block';
    }

    function hideInstructions() {
        document.getElementById('instructions').style.display = 'none';
    }

    function startWithDefault() {
        appState.musicas = [...defaultMusicas];
        showNotification('Cânticos de exemplo carregados! Clique em "INICIAR APRESENTAÇÃO"');
    }

    function exportMusicas() {
        if (appState.musicas.length === 0) {
            showNotification('Nenhum cântico para exportar!', 'error');
            return;
        }

        let content = '';
        appState.musicas.forEach(musica => {
            content += `===${musica.titulo}===\n`;
            musica.slides.forEach((slide, index) => {
                if (slide.trim() !== '' && index < musica.slides.length - 1) {
                    content += slide + '\n\n';
                }
            });
            content += '===FIM===\n\n';
        });

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'canticos_' + new Date().toISOString().split('T')[0] + '.txt';
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('Arquivo exportado com sucesso!');
    }

    function validateContent(content) {
        if (!content || content.trim().length === 0) {
            throw new Error('Arquivo vazio');
        }
        
        if (!content.includes('===')) {
            throw new Error('Formato inválido: marcadores === não encontrados');
        }
        
        return true;
    }

    function addSlideToMusica(musica, currentSlides, currentSlide) {
        if (currentSlide.length > 0) {
            currentSlides.push(currentSlide.join('\n'));
        }
        if (currentSlides.length > 0) {
            // Garante que sempre tenha um slide vazio no início e no final
            if (currentSlides[0].trim() !== '') {
                currentSlides.unshift("");
            }
            if (currentSlides[currentSlides.length - 1].trim() !== '') {
                currentSlides.push("");
            }
            musica.slides = currentSlides;
            return musica;
        }
        return null;
    }

    function parseTextFile(content) {
        try {
            validateContent(content);
        } catch (error) {
            throw error;
        }

        const musicas = [];
        const lines = content.split('\n');
        let currentMusica = null;
        let currentSlides = [];
        let currentSlide = [];

        for (let line of lines) {
            line = line.trim();
            
            if (line.startsWith('===') && line.endsWith('===') && line !== '===FIM===') {
                if (currentMusica) {
                    const musica = addSlideToMusica(
                        { titulo: currentMusica.toUpperCase(), slides: [] },
                        currentSlides,
                        currentSlide
                    );
                    if (musica) musicas.push(musica);
                }
                
                currentMusica = line.replace(/===/g, '').trim();
                currentSlides = [];
                currentSlide = [];
            }
            else if (line === '===FIM===') {
                if (currentSlide.length > 0) {
                    currentSlides.push(currentSlide.join('\n'));
                    currentSlide = [];
                }
            }
            else if (line === '' && currentSlide.length > 0) {
                currentSlides.push(currentSlide.join('\n'));
                currentSlide = [];
            }
            else if (line !== '' && currentMusica) {
                currentSlide.push(line);
            }
        }

        if (currentMusica) {
            const musica = addSlideToMusica(
                { titulo: currentMusica.toUpperCase(), slides: [] },
                currentSlides,
                currentSlide
            );
            if (musica) musicas.push(musica);
        }

        if (musicas.length === 0) {
            throw new Error('Nenhum cântico válido encontrado no arquivo');
        }

        return musicas;
    }

    // =============================
    // FUNÇÕES DE APRESENTAÇÃO
    // =============================

    function mostrarSlide() {
        const musica = appState.musicas[appState.musicaAtual];
        const texto = musica.slides[appState.slideAtual];
        
        titleDiv.textContent = musica.titulo;
        progressDiv.textContent = `${appState.slideAtual + 1}/${musica.slides.length}`;
        
        slideDiv.classList.remove("visible");
        
        if (appState.animationFrame) {
            cancelAnimationFrame(appState.animationFrame);
        }
        
        appState.animationFrame = requestAnimationFrame(() => {
            setTimeout(() => {
                // Aplica o estilo diferenciado
                if (texto.trim() !== '') {
                    slideDiv.innerHTML = aplicarEstiloDiferenciado(texto);
                } else {
                    slideDiv.textContent = texto;
                }
                
                // Define o tamanho base da fonte
                slideDiv.style.fontSize = appState.baseFontSize + 'rem';
                
                // Aplica ajuste automático se estiver habilitado
                if (appState.autoAdjustEnabled) {
                    setTimeout(() => {
                        ajustarFonteParaCaber();
                    }, 50);
                }
                
                // Mantém o texto branco mesmo no fundo branco
                slideDiv.style.color = '#ffffff';
                slideDiv.style.textShadow = '3px 3px 6px rgba(0, 0, 0, 0.9)';
                titleDiv.style.color = '#ffffff';
                progressDiv.style.color = '#cccccc';
                
                slideDiv.classList.add("visible");
                
                // Mostrar indicador de loop se estiver no último slide
                if (appState.slideAtual === musica.slides.length - 1 && appState.loopAtivo) {
                    loopIndicator.style.display = 'block';
                } else {
                    loopIndicator.style.display = 'none';
                }
                
                // Mostrar indicador de slide vazio
                if (texto.trim() === '') {
                    emptySlideIndicator.style.display = 'block';
                } else {
                    emptySlideIndicator.style.display = 'none';
                }
            }, 300); // Delay para transição mais suave
        });
    }

    function proximoSlide() {
        const musica = appState.musicas[appState.musicaAtual];
        
        // Conta quantos slides com conteúdo existem neste cântico
        const slidesComConteudo = contarSlidesComConteudo(musica);
        
        // Verifica se o cântico atual DEVE repetir
        const deveRepetir = deveRepetirCantico(musica.titulo);
        
        // REGRA 1: Se tiver apenas 1 slide com conteúdo e não está no início, avança para o próximo cântico
        if (slidesComConteudo === 1 && !appState.inicioDoCantico) {
            proximoCantico();
            return;
        }
        
        // Se estamos no início do cântico (slide vazio), vai para o primeiro slide com conteúdo
        if (appState.inicioDoCantico) {
            appState.slideAtual = encontrarPrimeiroSlideComConteudo(musica);
            if (appState.slideAtual === -1) {
                // Se não encontrou nenhum slide com conteúdo, vai para o próximo cântico
                proximoCantico();
                return;
            }
            appState.inicioDoCantico = false;
        } else {
            // Durante o loop normal, procura o próximo slide com conteúdo
            appState.slideAtual = encontrarProximoSlideComConteudo(musica, appState.slideAtual);
            
            // Se chegou ao final (não encontrou próximo slide com conteúdo)
            if (appState.slideAtual === -1) {
                // REGRA 2: Se o cântico DEVE repetir e tem mais de 1 slide, ativa o loop
                if (deveRepetir && slidesComConteudo > 1) {
                    appState.loopAtivo = true;
                    appState.slideAtual = encontrarPrimeiroSlideComConteudo(musica);
                } else {
                    // REGRA 3: Se não deve repetir, vai para o próximo cântico
                    proximoCantico();
                    return;
                }
            } else {
                appState.loopAtivo = false;
            }
        }
        
        mostrarSlide();
    }

    function slideAnterior() {
        const musica = appState.musicas[appState.musicaAtual];
        
        // Conta quantos slides com conteúdo existem neste cântico
        const slidesComConteudo = contarSlidesComConteudo(musica);
        
        // Verifica se o cântico atual DEVE repetir
        const deveRepetir = deveRepetirCantico(musica.titulo);
        
        // REGRA 1: Se tiver apenas 1 slide com conteúdo e não está no início, vai para o cântico anterior
        if (slidesComConteudo === 1 && !appState.inicioDoCantico) {
            canticoAnterior();
            return;
        }
        
        // REGRA 2: Se não deve repetir e não estamos no início, vai para o cântico anterior
        if (!deveRepetir && !appState.inicioDoCantico) {
            canticoAnterior();
            return;
        }
        
        // Se não estamos no início, procura o slide anterior com conteúdo
        if (!appState.inicioDoCantico) {
            let slideAnterior = appState.slideAtual - 1;
            
            // Percorre os slides para trás até encontrar um com conteúdo
            while (slideAnterior >= 0) {
                if (musica.slides[slideAnterior].trim() !== '') {
                    appState.slideAtual = slideAnterior;
                    appState.loopAtivo = false;
                    mostrarSlide();
                    return;
                }
                slideAnterior--;
            }
            
            // Se não encontrou nenhum slide anterior com conteúdo, vai para o início
            appState.inicioDoCantico = true;
            appState.slideAtual = 0; // Slide vazio inicial
        }
        
        mostrarSlide();
    }

    function proximoCantico() {
        const previousMusicaIndex = appState.musicaAtual;
        
        appState.musicaAtual = (appState.musicaAtual + 1) % appState.musicas.length;
        // Sempre começa no slide vazio (índice 0) quando muda de cântico
        appState.slideAtual = 0;
        appState.loopAtivo = false;
        appState.inicioDoCantico = true;
        
        if (previousMusicaIndex !== appState.musicaAtual) {
            slideDiv.classList.add('music-transition');
            setTimeout(() => {
                slideDiv.classList.remove('music-transition');
            }, 1000);
        }
        
        mostrarSlide();
    }

    function canticoAnterior() {
        const previousMusicaIndex = appState.musicaAtual;
        
        appState.musicaAtual--;
        if (appState.musicaAtual < 0) appState.musicaAtual = appState.musicas.length - 1;
        // Sempre começa no slide vazio (índice 0) quando muda de cântico
        appState.slideAtual = 0;
        appState.loopAtivo = false;
        appState.inicioDoCantico = true;
        
        if (previousMusicaIndex !== appState.musicaAtual) {
            slideDiv.classList.add('music-transition');
            setTimeout(() => {
                slideDiv.classList.remove('music-transition');
            }, 1000);
        }
        
        mostrarSlide();
    }

    function increaseFontSize() {
        if (appState.baseFontSize < 6) { // Aumentado de 5 para 6
            appState.baseFontSize += 0.2;
            if (!appState.autoAdjustEnabled) {
                slideDiv.style.fontSize = appState.baseFontSize + 'rem';
            } else {
                // Reaplica o ajuste automático com novo tamanho base
                mostrarSlide();
            }
        }
    }

    function decreaseFontSize() {
        if (appState.baseFontSize > 1.5) {
            appState.baseFontSize -= 0.2;
            if (!appState.autoAdjustEnabled) {
                slideDiv.style.fontSize = appState.baseFontSize + 'rem';
            } else {
                // Reaplica o ajuste automático com novo tamanho base
                mostrarSlide();
            }
        }
    }

    function startPresentation() {
        if (appState.musicas.length === 0) {
            showNotification('Nenhum canto carregado! Use "CÂNTICOS DE EXEMPLO" ou carregue um arquivo.', 'error');
            return;
        }

        configScreen.style.display = "none";
        presentationContainer.style.display = "flex";
        
        // Aplica a cor de fundo selecionada
        aplicarCorFundo(document.body, appState.corFundo);
        
        appState.musicaAtual = 0;
        appState.slideAtual = 0;
        appState.loopAtivo = false;
        appState.inicioDoCantico = true; // Começa no slide vazio
        mostrarSlide();
        
        showNotification('Apresentação iniciada! Use as setas para navegar.');
    }

    // =============================
    // EVENT LISTENERS
    // =============================

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    appState.musicas = parseTextFile(content);
                    showNotification('Arquivo carregado com sucesso! Clique em "INICIAR APRESENTAÇÃO"');
                } catch (error) {
                    showNotification('Erro: ' + error.message, 'error');
                }
            };
            reader.onerror = function() {
                showNotification('Erro ao ler o arquivo', 'error');
            };
            reader.readAsText(file);
        }
    });

    document.addEventListener("keydown", (e) => {
        if (presentationContainer.style.display === "flex") {
            if (e.key === "ArrowRight" || e.key === " ") {
                e.preventDefault();
                proximoSlide();
            }
            if (e.key === "ArrowLeft") {
                e.preventDefault();
                slideAnterior();
            }
            if (e.key === "ArrowUp" || e.key === "PageUp") {
                e.preventDefault();
                canticoAnterior();
            }
            if (e.key === "ArrowDown" || e.key === "PageDown" || e.key === "Enter") {
                e.preventDefault();
                proximoCantico();
            }
            if (e.key === "Escape") {
                presentationContainer.style.display = "none";
                configScreen.style.display = "flex";
                // Restaura o fundo original da configuração
                aplicarCorFundo(configScreen, appState.corFundo);
            }
            if (e.key === "+" || e.key === "=") {
                e.preventDefault();
                increaseFontSize();
            }
            if (e.key === "-" || e.key === "_") {
                e.preventDefault();
                decreaseFontSize();
            }
            if (e.key === "a" || e.key === "A") {
                e.preventDefault();
                resetAutoAdjust();
            }
        }
    });

    // Redimensionamento da janela
    window.addEventListener('resize', () => {
        if (presentationContainer.style.display === "flex" && appState.autoAdjustEnabled) {
            setTimeout(() => {
                ajustarFonteParaCaber();
            }, 100);
        }
    });

    // Inicializa com a cor preta selecionada
    selectColor('preto');
</script>
</body>
</html>
